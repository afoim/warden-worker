<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warden Worker - Bitwarden å…¼å®¹æœåŠ¡å™¨</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --primary-green: #00ff88;
            --primary-green-dark: #00cc6a;
            --primary-green-light: #66ffaa;
            --danger-color: #ff4444;
            --bg-black: #0a0e0f;
            --bg-dark: #0f1416;
            --bg-card: #141a1c;
            --bg-section: #1a2224;
            --border-color: #1f2a2d;
            --border-active: #00ff88;
            --text-primary: #e8f0f2;
            --text-secondary: #a0b4b8;
            --text-dim: #6b7f84;
            --success-bg: rgba(0, 255, 136, 0.1);
            --success-border: #00ff88;
            --error-bg: rgba(255, 68, 68, 0.1);
            --error-border: #ff4444;
            --warning-bg: rgba(255, 193, 7, 0.1);
            --warning-border: #ffc107;
            --info-bg: rgba(0, 191, 255, 0.1);
            --info-border: #00bfff;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        /* ç™½å¤©æ¨¡å¼ */
        [data-theme="light"] {
            --primary-green: #00a86b;
            --primary-green-dark: #008c5a;
            --primary-green-light: #00c97d;
            --danger-color: #dc3545;
            --bg-black: #f5f7fa;
            --bg-dark: #ffffff;
            --bg-card: #ffffff;
            --bg-section: #f8f9fa;
            --border-color: #e1e4e8;
            --border-active: #00a86b;
            --text-primary: #24292e;
            --text-secondary: #586069;
            --text-dim: #6a737d;
            --success-bg: #d4edda;
            --success-border: #28a745;
            --error-bg: #f8d7da;
            --error-border: #dc3545;
            --warning-bg: #fff3cd;
            --warning-border: #ffc107;
            --info-bg: #d1ecf1;
            --info-border: #17a2b8;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-glow: 0 0 20px rgba(0, 168, 107, 0.2);
        }

        [data-theme="light"] body {
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(0, 168, 107, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 168, 107, 0.02) 0%, transparent 50%);
        }

        [data-theme="light"] h1 {
            text-shadow: 0 0 30px rgba(0, 168, 107, 0.15);
        }

        [data-theme="light"] .section-title::before {
            filter: drop-shadow(0 0 8px rgba(0, 168, 107, 0.3));
        }

        [data-theme="light"] .qr-image {
            box-shadow: 0 0 20px rgba(0, 168, 107, 0.2);
        }

        [data-theme="light"] .tab::after {
            box-shadow: 0 0 10px rgba(0, 168, 107, 0.3);
        }

        [data-theme="light"] ::selection {
            background: rgba(0, 168, 107, 0.2);
            color: var(--text-primary);
        }

        /* ç™½å¤©æ¨¡å¼ä¸‹çš„ä¿¡æ¯æ¡†æ–‡å­—é¢œè‰²ä¼˜åŒ– */
        [data-theme="light"] .info-box {
            color: #0c5460;
        }

        [data-theme="light"] .warning-box {
            color: #856404;
        }

        [data-theme="light"] .success-box {
            color: #155724;
        }

        [data-theme="light"] .danger-box {
            color: #721c24;
        }

        /* ç™½å¤©æ¨¡å¼ä¸‹çš„è¡¨å•å…ƒç´ ä¼˜åŒ– */
        [data-theme="light"] .form-input:focus,
        [data-theme="light"] .form-textarea:focus {
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(0, 168, 107, 0.1), 0 0 20px rgba(0, 168, 107, 0.15);
        }

        [data-theme="light"] .form-input:hover,
        [data-theme="light"] .form-textarea:hover {
            border-color: var(--primary-green);
            background: #fafbfc;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 1rem;
            background: var(--bg-black);
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(0, 255, 136, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 255, 136, 0.03) 0%, transparent 50%);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            text-align: center;
            background: var(--bg-card);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            max-width: 850px;
            width: 100%;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .container:hover {
            border-color: rgba(0, 255, 136, 0.3);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        h1 {
            color: var(--primary-green);
            margin-bottom: 0.75rem;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 2.5rem;
            line-height: 1.8;
            font-size: 1rem;
            font-weight: 400;
        }

        .section {
            padding: 2rem;
            border-radius: 16px;
            margin-top: 1.5rem;
            text-align: left;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: rgba(0, 255, 136, 0.2);
            background: rgba(26, 34, 36, 0.8);
        }

        [data-theme="light"] .section:hover {
            border-color: rgba(0, 168, 107, 0.3);
            background: rgba(245, 250, 248, 0.9);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-green);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title::before {
            content: "ğŸ”";
            font-size: 1.3rem;
            filter: drop-shadow(0 0 8px rgba(0, 255, 136, 0.5));
        }

        .section-desc {
            color: var(--text-dim);
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .info-box {
            background: var(--info-bg);
            border-left: 3px solid var(--info-border);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.7;
            text-align: center;
        }

        .warning-box {
            background: var(--warning-bg);
            border-left: 3px solid var(--warning-border);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.7;
            text-align: center;
        }

        .success-box {
            background: var(--success-bg);
            border-left: 3px solid var(--success-border);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.7;
            text-align: center;
        }

        .danger-box {
            background: var(--error-bg);
            border-left: 3px solid var(--error-border);
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.25rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.7;
            text-align: center;
        }

        .form-group {
            margin-top: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.625rem;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            border: 1.5px solid var(--border-color);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary-green);
            background: var(--bg-black);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1), 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .form-input::placeholder {
            color: var(--text-dim);
        }

        .form-textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border-radius: 12px;
            border: 1.5px solid var(--border-color);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            resize: vertical;
            transition: all 0.3s ease;
            outline: none;
            line-height: 1.6;
        }

        .form-textarea:focus {
            border-color: var(--primary-green);
            background: var(--bg-black);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1), 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .btn {
            display: inline-block;
            background: var(--primary-green);
            color: var(--bg-black);
            padding: 1rem 2rem;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            background: var(--primary-green-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
        }

        .btn-secondary {
            background: var(--bg-section);
            color: var(--text-primary);
            border: 1.5px solid var(--border-color);
            box-shadow: none;
        }

        .btn-secondary:hover {
            background: var(--bg-dark);
            border-color: var(--primary-green);
            color: var(--primary-green);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .result {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border-radius: 12px;
            background: var(--bg-dark);
            white-space: pre-wrap;
            font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            font-size: 0.875rem;
            text-align: left;
            border: 1.5px solid var(--border-color);
            display: none;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .result.show {
            display: block;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .qr-container {
            display: flex;
            justify-content: center;
            margin-top: 1.25rem;
        }

        .qr-image {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 16px;
            border: 2px solid var(--primary-green);
            padding: 0.75rem;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-green) var(--bg-section);
        }

        .tabs::-webkit-scrollbar {
            height: 4px;
        }

        .tabs::-webkit-scrollbar-track {
            background: var(--bg-section);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: var(--primary-green);
            border-radius: 2px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: var(--primary-green-light);
        }

        .tab {
            padding: 1rem 1.75rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            position: relative;
        }

        .tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: var(--primary-green);
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .tab:hover {
            color: var(--text-secondary);
            background: rgba(0, 255, 136, 0.05);

        }

        .tab:hover::after {
            width: 100%;
        }

        .tab.active {
            color: var(--primary-green);
            font-weight: 600;
        }

        .tab.active::after {
            width: 100%;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .tab-content.active {
            display: block;
        }

        .footer {
            color: var(--text-dim);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 1.5rem;
        }

        .footer a {
            color: var(--primary-green);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: var(--primary-green-light);
            text-decoration: underline;
        }

        @media (max-width: 640px) {
            .container {
                padding: 2rem 1.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }

            .tab {
                padding: 0.875rem 1.25rem;
                font-size: 0.875rem;
            }

            .section {
                padding: 1.5rem;
            }

            .btn {
                padding: 0.875rem 1.5rem;
                font-size: 0.9rem;
            }
        }

        /* å¹³æ»‘æ»šåŠ¨ */
        html {
            scroll-behavior: smooth;
        }

        /* é€‰ä¸­æ–‡æœ¬æ ·å¼ */
        ::selection {
            background: rgba(0, 255, 136, 0.3);
            color: var(--text-primary);
        }

        /* ç„¦ç‚¹å¯è§æ€§ */
        *:focus-visible {
            outline: 2px solid var(--primary-green);
            outline-offset: 2px;
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-toggle {
            position: fixed;
            top: 2rem;
            right: 2rem;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            border-color: var(--primary-green);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        @media (max-width: 640px) {
            .theme-toggle {
                top: 1rem;
                right: 1rem;
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
<!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
<button class="theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜">
    <span id="themeIcon">ğŸŒ™</span>
</button>

<div class="container">
    <h1>ğŸ” Warden Worker</h1>
    <div class="subtitle">
        è¿è¡Œåœ¨ Cloudflare Workers ä¸Šçš„ Bitwarden å…¼å®¹æœåŠ¡å™¨<br>
        å¼€æºã€å®‰å…¨ã€å¿«é€Ÿã€æ˜“ç”¨çš„å¯†ç ç®¡ç†è§£å†³æ–¹æ¡ˆ<br>
        æœåŠ¡å™¨åœ°å€ï¼š<span id="serverUrl"></span>
        <button id="copyServerUrl" class="copy-btn" title="å¤åˆ¶æœåŠ¡å™¨åœ°å€">ğŸ“‹</button>
    </div>

    <!-- TAB å¯¼èˆª -->
    <div class="tabs">
        <button class="tab active" data-tab="register">ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ</button>
        <button class="tab" data-tab="password">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
        <button class="tab" data-tab="email">ğŸ“§ ä¿®æ”¹é‚®ç®±</button>
        <button class="tab" data-tab="totp">ğŸ›¡ï¸ äºŒæ¬¡éªŒè¯</button>
        <button class="tab" data-tab="backup">ğŸ’¾ å¤‡ä»½è¿˜åŸ</button>
    </div>

    <!-- ç”¨æˆ·æ³¨å†Œ TAB -->
    <div class="tab-content active" id="tab-register">
        <div class="section">
            <div class="section-title">ç”¨æˆ·æ³¨å†Œ</div>
            <div class="form-group">
                <label class="form-label">é‚®ç®±åœ°å€</label>
                <input id="registerEmail" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">ç™»å½•å¯†ç </label>
                <input id="registerPassword" type="password" class="form-input" placeholder="è¯·è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">ç¡®è®¤å¯†ç </label>
                <input id="registerPasswordConfirm" type="password" class="form-input" placeholder="å†æ¬¡è¾“å…¥è¿™ä¸ªå¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç æç¤ºï¼ˆå¯é€‰ï¼‰</label>
                <input id="registerHint" type="text" class="form-input" placeholder="å¯†ç è¾…åŠ©æç¤ºçº¿ç´¢">
            </div>
            <br/><br/>
            <div class="info-box">
                ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>ä¸»å¯†ç æ˜¯è§£å¯†æ‰€æœ‰æ•°æ®çš„å”¯ä¸€å¯†é’¥ï¼Œè¯·åŠ¡å¿…ç‰¢è®°ã€‚<br/>
                ğŸ’¡ <strong>éšç§å£°æ˜ï¼š</strong>æœåŠ¡å™¨ä¸å­˜å‚¨æ˜æ–‡å¯†ç ï¼Œå¿˜è®°å¯†ç åå°†æ— æ³•æ‰¾å›ã€‚
            </div>
            <div class="btn-group">
                <a class="btn" href="#" id="registerSubmit">ç«‹å³æ³¨å†Œ</a>
            </div>
            <div id="registerResult" class="result"></div>
        </div>
        <div class="success-box" style="margin-top: 1.5rem;">
            æ‰€æœ‰å¯†ç æ“ä½œå‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼ŒæœåŠ¡å™¨ä»…æ¥æ”¶åŠ å¯†åçš„æ•°æ®<br/>
            åœ¨è¿›è¡Œé‡è¦æ“ä½œå‰ï¼Œè¯·å…ˆå¯¼å‡ºå¤‡ä»½ï¼Œé¿å…æ•°æ®ä¸¢å¤±
        </div>
    </div>

    <!-- ä¿®æ”¹ä¸»å¯†ç  TAB -->
    <div class="tab-content" id="tab-password">
        <div class="section">
            <div class="section-title">ä¿®æ”¹å¯†ç </div>
            <div class="form-group">
                <label class="form-label">é‚®ç®±åœ°å€</label>
                <input id="email" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">å½“å‰å¯†ç </label>
                <input id="oldPassword" type="password" class="form-input" placeholder="è¯·è¾“å…¥å½“å‰ä¸»å¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">æ–°çš„å¯†ç </label>
                <input id="newPassword" type="password" class="form-input" placeholder="è¯·è¾“å…¥æ–°çš„ä¸»å¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç æç¤ºï¼ˆå¯é€‰ï¼‰</label>
                <input id="hint" type="text" class="form-input" placeholder="å¯†ç è¾…åŠ©æç¤ºçº¿ç´¢">
            </div>
            <br/><br/>
            <div class="info-box">
                ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>ä¸»å¯†ç æ˜¯è§£å¯†æ‰€æœ‰æ•°æ®çš„å”¯ä¸€å¯†é’¥ï¼Œè¯·åŠ¡å¿…ç‰¢è®°ã€‚<br/>
                ğŸ’¡ <strong>éšç§å£°æ˜ï¼š</strong>æœåŠ¡å™¨ä¸å­˜å‚¨æ˜æ–‡å¯†ç ï¼Œå¿˜è®°å¯†ç åå°†æ— æ³•æ‰¾å›ã€‚
            </div>
            <div class="btn-group">
                <a class="btn" href="#" id="submit">ç¡®è®¤ä¿®æ”¹</a>
            </div>
            <div id="result" class="result"></div>
        </div>

        <div class="success-box" style="margin-top: 1.5rem;">
            æ‰€æœ‰å¯†ç æ“ä½œå‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼ŒæœåŠ¡å™¨ä»…æ¥æ”¶åŠ å¯†åçš„æ•°æ®<br/>
            åœ¨è¿›è¡Œé‡è¦æ“ä½œå‰ï¼Œè¯·å…ˆå¯¼å‡ºå¤‡ä»½ï¼Œé¿å…æ•°æ®ä¸¢å¤±
        </div>
    </div>

    <!-- ä¿®æ”¹é‚®ç®± TAB -->
    <div class="tab-content" id="tab-email">
        <div class="section">
            <div class="section-title">ä¿®æ”¹é‚®ç®±</div>
            <div class="form-group">
                <label class="form-label">å½“å‰é‚®ç®±</label>
                <input id="emailCurrent" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">æ–°é‚®ç®±</label>
                <input id="emailNew" type="email" class="form-input" placeholder="next@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">ç¡®è®¤æ–°é‚®ç®±</label>
                <input id="emailNewConfirm" type="email" class="form-input" placeholder="å†æ¬¡è¾“å…¥æ–°é‚®ç®±">
            </div>
            <div class="form-group">
                <label class="form-label">ä¸»å¯†ç </label>
                <input id="emailPassword" type="password" class="form-input" placeholder="è¾“å…¥å¯†ç éªŒè¯èº«ä»½">
            </div>
            <br/>
            <div class="info-box" style="margin-top: 1.5rem;">
                ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>ä¿®æ”¹é‚®ç®±åï¼Œä¸»å¯†é’¥ä¼šä½¿ç”¨æ–°é‚®ç®±é‡æ–°æ´¾ç”Ÿã€‚<br/>
                è¯·ä½¿ç”¨æ–°é‚®ç®±ç™»å½• Bitwarden å®¢æˆ·ç«¯ã€‚
            </div>
            <div class="btn-group">
                <a class="btn" href="#" id="submitEmail">ç¡®è®¤ä¿®æ”¹</a>
            </div>
            <div id="resultEmail" class="result"></div>
        </div>

        <div class="success-box" style="margin-top: 1.5rem;">
            æ‰€æœ‰å¯†ç æ“ä½œå‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼ŒæœåŠ¡å™¨ä»…æ¥æ”¶åŠ å¯†åçš„æ•°æ®<br/>
            åœ¨è¿›è¡Œé‡è¦æ“ä½œå‰ï¼Œè¯·å…ˆå¯¼å‡ºå¤‡ä»½ï¼Œé¿å…æ•°æ®ä¸¢å¤±
        </div>
    </div>

    <!-- äºŒæ¬¡éªŒè¯ TOTP TAB -->
    <div class="tab-content" id="tab-totp">
        <div class="section">
            <div class="section-title">ç™»å½•äºŒæ¬¡éªŒè¯ï¼ˆTOTPï¼‰</div>
            <div class="section-desc">å¯ç”¨åï¼Œç™»å½•æ—¶éœ€è¦è¾“å…¥åŠ¨æ€éªŒè¯ç ï¼Œæå‡è´¦æˆ·å®‰å…¨æ€§</div>

            <div class="form-group">
                <label class="form-label">é‚®ç®±åœ°å€</label>
                <input id="totpEmail" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">ä¸»å¯†ç </label>
                <input id="totpPassword" type="password" class="form-input" placeholder="è¾“å…¥å¯†ç éªŒè¯èº«ä»½">
            </div>

            <div class="btn-group">
                <a class="btn" href="#" id="totpRequest">ç”Ÿæˆå¯†é’¥</a>
            </div>

            <div class="form-group">
                <label class="form-label">å¯†é’¥ï¼ˆSecretï¼‰</label>
                <input id="totpSecret" type="text" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">OTP Auth URI</label>
                <textarea id="totpOtpauth" rows="3" class="form-textarea" readonly></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">äºŒç»´ç </label>
                <div class="qr-container">
                    <img id="totpQr" alt="TOTP QR Code" class="qr-image">
                </div>
            </div>
            <br/><br/>
            <div class="info-box">
                ğŸ“± è¯·ä½¿ç”¨è®¤è¯Appï¼ˆå¦‚Google Authenticatorï¼‰æ‰«æäºŒç»´ç æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥
            </div>

            <div class="form-group">
                <label class="form-label">éªŒè¯ç </label>
                <input id="totpCode" type="text" class="form-input" placeholder="è¾“å…¥ 6 ä½éªŒè¯ç " maxlength="6">
            </div>

            <div class="btn-group">
                <a class="btn" href="#" id="totpEnable">å¯ç”¨éªŒè¯</a>
                <a class="btn btn-secondary" href="#" id="totpDisable">ç¦ç”¨éªŒè¯</a>
            </div>
            <div id="resultTotp" class="result"></div>
        </div>

        <div class="info-box" style="margin-top: 1.5rem;">
            ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>å¯ç”¨äºŒæ¬¡éªŒè¯åï¼Œæ¯æ¬¡ç™»å½•éƒ½éœ€è¦è¾“å…¥åŠ¨æ€éªŒè¯ç ã€‚<br/>
            ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>è¯·å¦¥å–„ä¿ç®¡è®¤è¯å™¨ä¸­çš„å¯†é’¥ï¼Œé¿å…ä¸¢å¤±å¹³å°è®¿æƒé™ã€‚
        </div>
    </div>

    <!-- å¤‡ä»½è¿˜åŸ TAB -->
    <div class="tab-content" id="tab-backup">
        <div class="section">
            <div class="section-title">å¤‡ä»½ç®¡ç†</div>
            <div class="section-desc">å¯¼å‡ºæˆ–è¿˜åŸæ‚¨çš„å¯†ç åº“æ•°æ®</div>

            <!-- å•é€‰åˆ‡æ¢ -->
            <div class="form-group">
                <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="backupMode" value="export" checked style="margin-right: 0.5rem;">
                        <span>ğŸ“¥ å¯¼å‡ºå¤‡ä»½</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="backupMode" value="import" style="margin-right: 0.5rem;">
                        <span>ğŸ“¤ å¯¼å…¥è¿˜åŸ</span>
                    </label>
                </div>
            </div>

            <!-- å¯¼å‡ºæ¨¡å¼ -->
            <div id="exportMode">
                <div class="form-group">
                    <label class="form-label">é‚®ç®±åœ°å€</label>
                    <input id="backupEmail" type="email" class="form-input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">ä¸»å¯†ç </label>
                    <input id="backupPassword" type="password" class="form-input" placeholder="è¾“å…¥ä¸»å¯†ç éªŒè¯èº«ä»½">
                </div>

                <div class="btn-group">
                    <a class="btn" href="#" id="exportBackup">ğŸ“¥ å¯¼å‡ºå¤‡ä»½</a>
                </div>
            </div>

            <!-- å¯¼å…¥æ¨¡å¼ -->
            <div id="importMode" style="display: none;">
                <div class="form-group">
                    <label class="form-label">é‚®ç®±åœ°å€</label>
                    <input id="importEmail" type="email" class="form-input" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">ä¸»å¯†ç </label>
                    <input id="importPassword" type="password" class="form-input" placeholder="è¾“å…¥å¯†ç éªŒè¯èº«ä»½">
                </div>
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©å¤‡ä»½æ–‡ä»¶</label>
                    <input id="importFile" type="file" class="form-input" accept=".json">
                </div>

                <div class="btn-group">
                    <a class="btn" href="#" id="importBackup">ğŸ“¤ å¯¼å…¥è¿˜åŸ</a>
                </div>
            </div>

            <div id="resultBackup" class="result"></div>
            <div class="warning-box" style="margin-top: 1.5rem;">
                ğŸ’¡ å¯¼å‡ºçš„å¤‡ä»½æ–‡ä»¶åŒ…å«åŠ å¯†æ•°æ®ï¼Œè¯·æ‚¨å¦¥å–„ä¿ç®¡<br/>
                ğŸ’¡ å¯¼å…¥æ—¶ï¼Œå°†è¦†ç›–æ‚¨å½“å‰çš„å¯†ç åº“æ•°æ®å…¨éƒ¨å†…å®¹
            </div>
        </div>

        <div class="section" style="margin-top: 2rem;">
            <div class="section-title" style="color: var(--danger-color);">âš ï¸ åˆ é™¤è´¦å·</div>
            <div class="section-desc">æ°¸ä¹…åˆ é™¤æ‚¨çš„è´¦å·å’Œæ‰€æœ‰æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤</div>

            <div class="form-group">
                <label class="form-label">é‚®ç®±åœ°å€</label>
                <input id="deleteEmail" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">ä¸»å¯†ç </label>
                <input id="deletePassword" type="password" class="form-input" placeholder="è¾“å…¥å¯†ç éªŒè¯èº«ä»½">
            </div>
            <div class="btn-group">
                <a class="btn" href="#" id="deleteAccount" style="background: var(--danger-color);">ğŸ—‘ï¸ åˆ é™¤è´¦å·</a>
            </div>
            <div id="resultDelete" class="result"></div>
        </div>

        <div class="danger-box" style="margin-top: 1.5rem;">
            âš ï¸ <strong>é‡è¦æé†’</strong><br/>åˆ é™¤è´¦å·åï¼Œæ‰€æœ‰æ•°æ®å°†æ°¸ä¹…ä¸¢å¤±ï¼Œæ— æ³•æ¢å¤<br/>
        </div>
    </div>

    <div class="footer">
        Powered by <a href="https://github.com/PIKACHUIM/warden-worker">Warden Worker</a>
    </div>
</div>

<script>
    // ========== æœåŠ¡å™¨åœ°å€æ˜¾ç¤ºå’Œå¤åˆ¶åŠŸèƒ½ ==========
    // ä» URL è·å–å¹¶æ˜¾ç¤ºæœåŠ¡å™¨åœ°å€
    const serverUrlElement = document.getElementById('serverUrl');
    const copyServerUrlBtn = document.getElementById('copyServerUrl');
    const serverUrl = window.location.origin;
    
    // æ˜¾ç¤ºæœåŠ¡å™¨åœ°å€
    serverUrlElement.textContent = serverUrl;
    
    // å¤åˆ¶æœåŠ¡å™¨åœ°å€åŠŸèƒ½
    copyServerUrlBtn.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(serverUrl);
            // ä¸´æ—¶æ”¹å˜æŒ‰é’®æ–‡æœ¬æç¤ºå¤åˆ¶æˆåŠŸ
            const originalText = copyServerUrlBtn.textContent;
            copyServerUrlBtn.textContent = 'âœ…';
            setTimeout(() => {
                copyServerUrlBtn.textContent = originalText;
            }, 2000);
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•å¤åˆ¶
            const textArea = document.createElement('textarea');
            textArea.value = serverUrl;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = copyServerUrlBtn.textContent;
                copyServerUrlBtn.textContent = 'âœ…';
                setTimeout(() => {
                    copyServerUrlBtn.textContent = originalText;
                }, 2000);
            } catch (err2) {
                console.error('é™çº§å¤åˆ¶ä¹Ÿå¤±è´¥:', err2);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }
            document.body.removeChild(textArea);
        }
    });

    // ========== ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½ ==========
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const htmlElement = document.documentElement;

    // ä» localStorage è¯»å–ä¸»é¢˜åå¥½ï¼Œé»˜è®¤ä¸ºæš—é»‘æ¨¡å¼
    // è·å–ç³»ç»Ÿä¸»é¢˜åå¥½
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const systemTheme = prefersDark ? 'dark' : 'light';
    const savedTheme = localStorage.getItem('theme') || systemTheme;
    
    // åº”ç”¨ä¸»é¢˜
    function applyTheme(theme) {
        if (theme === 'light') {
            htmlElement.setAttribute('data-theme', 'light');
            themeIcon.textContent = 'â˜€ï¸';
        } else {
            htmlElement.removeAttribute('data-theme');
            themeIcon.textContent = 'ğŸŒ™';
        }
        localStorage.setItem('theme', theme);
    }

    // åˆå§‹åŒ–ä¸»é¢˜
    applyTheme(savedTheme);

    // åˆ‡æ¢ä¸»é¢˜
    themeToggle.addEventListener('click', () => {
        const currentTheme = htmlElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        applyTheme(newTheme);
    });

    // TAB åˆ‡æ¢åŠŸèƒ½
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.getAttribute('data-tab');

            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));

            // æ·»åŠ æ´»åŠ¨çŠ¶æ€
            tab.classList.add('active');
            document.getElementById(`tab-${targetTab}`).classList.add('active');
        });
    });

    // å¤‡ä»½æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
    const backupModeRadios = document.querySelectorAll('input[name="backupMode"]');
    backupModeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (e.target.value === 'export') {
                exportMode.style.display = 'block';
                importMode.style.display = 'none';
            } else {
                exportMode.style.display = 'none';
                importMode.style.display = 'block';
            }
            hideResult(resultBackupEl);
        });
    });

    const registerSubmitBtn = document.getElementById('registerSubmit');
    const registerEmailInput = document.getElementById('registerEmail');
    const registerPasswordInput = document.getElementById('registerPassword');
    const registerPasswordConfirmInput = document.getElementById('registerPasswordConfirm');
    const registerHintInput = document.getElementById('registerHint');
    const registerResultEl = document.getElementById('registerResult');
    const submitBtn = document.getElementById('submit');
    const submitEmailBtn = document.getElementById('submitEmail');
    const emailInput = document.getElementById('email');
    const oldPasswordInput = document.getElementById('oldPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const hintInput = document.getElementById('hint');
    const resultEl = document.getElementById('result');
    const emailCurrentInput = document.getElementById('emailCurrent');
    const emailNewInput = document.getElementById('emailNew');
    const emailNewConfirmInput = document.getElementById('emailNewConfirm');
    const emailPasswordInput = document.getElementById('emailPassword');
    const resultEmailEl = document.getElementById('resultEmail');
    const totpEmailInput = document.getElementById('totpEmail');
    const totpPasswordInput = document.getElementById('totpPassword');
    const totpRequestBtn = document.getElementById('totpRequest');
    const totpEnableBtn = document.getElementById('totpEnable');
    const totpDisableBtn = document.getElementById('totpDisable');
    const totpSecretInput = document.getElementById('totpSecret');
    const totpOtpauthInput = document.getElementById('totpOtpauth');
    const totpQrImg = document.getElementById('totpQr');
    const totpCodeInput = document.getElementById('totpCode');
    const resultTotpEl = document.getElementById('resultTotp');
    const backupEmailInput = document.getElementById('backupEmail');
    const backupPasswordInput = document.getElementById('backupPassword');
    const exportBackupBtn = document.getElementById('exportBackup');
    const importBackupBtn = document.getElementById('importBackup');
    const importFileInput = document.getElementById('importFile');
    const importEmailInput = document.getElementById('importEmail');
    const importPasswordInput = document.getElementById('importPassword');
    const deleteEmailInput = document.getElementById('deleteEmail');
    const deletePasswordInput = document.getElementById('deletePassword');
    const deleteAccountBtn = document.getElementById('deleteAccount');
    const resultBackupEl = document.getElementById('resultBackup');
    const resultDeleteEl = document.getElementById('resultDelete');
    const exportMode = document.getElementById('exportMode');
    const importMode = document.getElementById('importMode');

    const encoder = new TextEncoder();

    function showResult(element, message, type = 'info') {
        element.textContent = message;
        element.className = 'result show';
        if (type === 'success') {
            element.style.background = '#d4edda';
            element.style.borderColor = '#28a745';
            element.style.color = '#155724';
        } else if (type === 'error') {
            element.style.background = '#f8d7da';
            element.style.borderColor = '#dc3545';
            element.style.color = '#721c24';
        } else {
            element.style.background = '#d1ecf1';
            element.style.borderColor = '#17a2b8';
            element.style.color = '#0c5460';
        }
    }

    function hideResult(element) {
        element.className = 'result';
    }

    function concatBytes(a, b) {
        const out = new Uint8Array(a.length + b.length);
        out.set(a, 0);
        out.set(b, a.length);
        return out;
    }

    function b64encode(bytes) {
        let binary = '';
        const chunkSize = 0x8000;
        for (let i = 0; i < bytes.length; i += chunkSize) {
            const chunk = bytes.subarray(i, i + chunkSize);
            binary += String.fromCharCode(...chunk);
        }
        return btoa(binary);
    }

    function b64decode(str) {
        const binary = atob(str);
        const out = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            out[i] = binary.charCodeAt(i);
        }
        return out;
    }

    function pkcs7Pad(bytes, blockSize) {
        const padLen = blockSize - (bytes.length % blockSize);
        const out = new Uint8Array(bytes.length + padLen);
        out.set(bytes, 0);
        out.fill(padLen, bytes.length);
        return out;
    }

    function pkcs7Unpad(bytes) {
        if (bytes.length === 0) throw new Error('Invalid padding');
        const padLen = bytes[bytes.length - 1];
        if (padLen <= 0 || padLen > 16) throw new Error('Invalid padding');
        for (let i = bytes.length - padLen; i < bytes.length; i++) {
            if (bytes[i] !== padLen) throw new Error('Invalid padding');
        }
        return bytes.subarray(0, bytes.length - padLen);
    }

    async function pbkdf2Sha256(passwordBytes, saltBytes, iterations, lengthBytes) {
        const keyMaterial = await crypto.subtle.importKey(
            'raw',
            passwordBytes,
            'PBKDF2',
            false,
            ['deriveBits']
        );
        const bits = await crypto.subtle.deriveBits(
            {
                name: 'PBKDF2',
                salt: saltBytes,
                iterations,
                hash: 'SHA-256'
            },
            keyMaterial,
            lengthBytes * 8
        );
        return new Uint8Array(bits);
    }

    async function hkdfExpandSha256(prkBytes, infoBytes, lengthBytes) {
        if (lengthBytes > 32) {
            throw new Error('HKDF-Expand length too large for this implementation');
        }
        const infoWithCounter = concatBytes(infoBytes, new Uint8Array([1]));
        const okm = await hmacSha256(prkBytes, infoWithCounter);
        return okm.subarray(0, lengthBytes);
    }

    async function stretchMasterKey(masterKeyBytes) {
        const encKey = await hkdfExpandSha256(masterKeyBytes, encoder.encode('enc'), 32);
        const macKey = await hkdfExpandSha256(masterKeyBytes, encoder.encode('mac'), 32);
        return {encKey, macKey};
    }

    async function hmacSha256(macKeyBytes, dataBytes) {
        const key = await crypto.subtle.importKey(
            'raw',
            macKeyBytes,
            {name: 'HMAC', hash: 'SHA-256'},
            false,
            ['sign', 'verify']
        );
        const sig = await crypto.subtle.sign('HMAC', key, dataBytes);
        return new Uint8Array(sig);
    }

    async function hmacVerifySha256(macKeyBytes, dataBytes, signatureBytes) {
        const key = await crypto.subtle.importKey(
            'raw',
            macKeyBytes,
            {name: 'HMAC', hash: 'SHA-256'},
            false,
            ['verify']
        );
        return await crypto.subtle.verify('HMAC', key, signatureBytes, dataBytes);
    }

    async function aesCbcEncrypt(encKeyBytes, ivBytes, plainBytes) {
        const key = await crypto.subtle.importKey('raw', encKeyBytes, {name: 'AES-CBC'}, false, ['encrypt']);
        const ct = await crypto.subtle.encrypt({name: 'AES-CBC', iv: ivBytes}, key, plainBytes);
        return new Uint8Array(ct);
    }

    async function aesCbcDecrypt(encKeyBytes, ivBytes, cipherBytes) {
        const key = await crypto.subtle.importKey('raw', encKeyBytes, {name: 'AES-CBC'}, false, ['decrypt']);
        const pt = await crypto.subtle.decrypt({name: 'AES-CBC', iv: ivBytes}, key, cipherBytes);
        return new Uint8Array(pt);
    }

    async function decryptEncString(encString, encKeyBytes, macKeyBytes) {
        const parts = encString.split('.', 2);
        if (parts.length !== 2) throw new Error('Invalid encString');
        const encType = parts[0];
        if (encType !== '2') throw new Error(`Unsupported encType: ${encType}`);
        const payload = parts[1].split('|');
        if (payload.length !== 3) throw new Error('Invalid encString payload');
        const iv = b64decode(payload[0]);
        const ct = b64decode(payload[1]);
        const mac = b64decode(payload[2]);
        const dataToMac = concatBytes(iv, ct);
        const ok = await hmacVerifySha256(macKeyBytes, dataToMac, mac);
        if (!ok) throw new Error('MAC æ ¡éªŒå¤±è´¥ï¼ˆæ—§ä¸»å¯†ç å¯èƒ½ä¸æ­£ç¡®ï¼‰');
        const raw = await aesCbcDecrypt(encKeyBytes, iv, ct);
        try {
            return {
                plainBytes: pkcs7Unpad(raw),
                usedPadding: true,
                ivLen: iv.length,
                ctLen: ct.length,
                macLen: mac.length
            };
        } catch {
            return {plainBytes: raw, usedPadding: false, ivLen: iv.length, ctLen: ct.length, macLen: mac.length};
        }
    }

    async function encryptEncString(plainBytes, encKeyBytes, macKeyBytes, usePadding) {
        const iv = crypto.getRandomValues(new Uint8Array(16));
        const input = usePadding ? pkcs7Pad(plainBytes, 16) : plainBytes;
        const ct = await aesCbcEncrypt(encKeyBytes, iv, input);
        const mac = await hmacSha256(macKeyBytes, concatBytes(iv, ct));
        return `2.${b64encode(iv)}|${b64encode(ct)}|${b64encode(mac)}`;
    }

    async function generateRsaKeyPair(encKey, macKey) {
        // ç”Ÿæˆ RSA-OAEP 2048 ä½å¯†é’¥å¯¹
        const keyPair = await crypto.subtle.generateKey(
            {
                name: 'RSA-OAEP',
                modulusLength: 2048,
                publicExponent: new Uint8Array([0x01, 0x00, 0x01]), // 65537
                hash: 'SHA-1'
            },
            true,
            ['encrypt', 'decrypt']
        );

        // å¯¼å‡ºå…¬é’¥ä¸º SPKI æ ¼å¼
        const publicKeySpki = await crypto.subtle.exportKey('spki', keyPair.publicKey);
        const publicKeyBytes = new Uint8Array(publicKeySpki);

        // å¯¼å‡ºç§é’¥ä¸º PKCS8 æ ¼å¼
        const privateKeyPkcs8 = await crypto.subtle.exportKey('pkcs8', keyPair.privateKey);
        const privateKeyBytes = new Uint8Array(privateKeyPkcs8);

        // ä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†ç§é’¥
        const encryptedPrivateKey = await encryptEncString(privateKeyBytes, encKey, macKey, true);

        // è¿”å›å…¬é’¥ï¼ˆbase64ï¼‰å’ŒåŠ å¯†çš„ç§é’¥
        return {
            publicKey: b64encode(publicKeyBytes),
            encryptedPrivateKey: encryptedPrivateKey
        };
    }

    async function deriveMasterKey(email, password, kdfIterations) {
        const salt = encoder.encode(email.toLowerCase());
        const pw = encoder.encode(password);
        return await pbkdf2Sha256(pw, salt, kdfIterations, 32);
    }

    async function deriveMasterPasswordHash(masterKeyBytes, password) {
        const pw = encoder.encode(password);
        const hash = await pbkdf2Sha256(masterKeyBytes, pw, 1, 32);
        return b64encode(hash);
    }

    async function prelogin(email) {
        const preloginResp = await fetch('/identity/accounts/prelogin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email})
        });
        const preloginText = await preloginResp.text();
        if (!preloginResp.ok) {
            throw new Error(`prelogin å¤±è´¥ HTTP ${preloginResp.status}\n${preloginText}`);
        }
        const preloginJson = JSON.parse(preloginText);
        return Number(preloginJson.kdfIterations);
    }

    async function login(email, masterPasswordHash) {
        const form = new URLSearchParams();
        form.set('grant_type', 'password');
        form.set('username', email);
        form.set('password', masterPasswordHash);
        const tokenResp = await fetch('/identity/connect/token', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: form.toString()
        });
        const tokenText = await tokenResp.text();
        if (!tokenResp.ok) {
            throw new Error(`ç™»å½•å¤±è´¥ HTTP ${tokenResp.status}\n${tokenText}`);
        }
        return JSON.parse(tokenText);
    }

    // ç”¨æˆ·æ³¨å†Œ
    registerSubmitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(registerResultEl);

        try {
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value;
            const passwordConfirm = registerPasswordConfirmInput.value;
            const hint = registerHintInput.value.trim();

            if (!email || !password || !passwordConfirm) {
                showResult(registerResultEl, 'âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showResult(registerResultEl, 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                return;
            }

            if (password.length < 8) {
                showResult(registerResultEl, 'âŒ ä¸»å¯†ç é•¿åº¦è‡³å°‘ä¸º 8 ä½', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showResult(registerResultEl, 'âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            showResult(registerResultEl, 'â³ æ­£åœ¨ç”ŸæˆåŠ å¯†å¯†é’¥...', 'info');

            // é»˜è®¤ KDF è¿­ä»£æ¬¡æ•°
            const kdfIterations = 600000;

            // æ´¾ç”Ÿä¸»å¯†é’¥
            const masterKey = await deriveMasterKey(email, password, kdfIterations);
            const masterPasswordHash = await deriveMasterPasswordHash(masterKey, password);

            // ç”Ÿæˆç”¨æˆ·å¯¹ç§°å¯†é’¥
            const symmetricKey = crypto.getRandomValues(new Uint8Array(64));
            const stretched = await stretchMasterKey(masterKey);
            const protectedSymmetricKey = await encryptEncString(
                symmetricKey,
                stretched.encKey,
                stretched.macKey,
                true
            );

            showResult(registerResultEl, 'â³ æ­£åœ¨ç”Ÿæˆ RSA å¯†é’¥å¯¹...', 'info');

            // ç”Ÿæˆ RSA å¯†é’¥å¯¹
            const rsaKeyPair = await generateRsaKeyPair(stretched.encKey, stretched.macKey);

            showResult(registerResultEl, 'â³ æ­£åœ¨åˆ›å»ºè´¦æˆ·...', 'info');

            // è°ƒç”¨æ³¨å†Œ API
            const registerResp = await fetch('/identity/accounts/register/finish', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: email,
                    masterPasswordHash: masterPasswordHash,
                    masterPasswordHint: hint || null,
                    userSymmetricKey: protectedSymmetricKey,
                    userAsymmetricKeys: {
                        publicKey: rsaKeyPair.publicKey,
                        encryptedPrivateKey: rsaKeyPair.encryptedPrivateKey
                    },
                    kdf: 0,
                    kdfIterations: kdfIterations
                })
            });

            const registerText = await registerResp.text();
            if (!registerResp.ok) {
                showResult(registerResultEl, `âŒ æ³¨å†Œå¤±è´¥ HTTP ${registerResp.status}\n${registerText}`, 'error');
                return;
            }

            showResult(registerResultEl, 'âœ… æ³¨å†ŒæˆåŠŸï¼ä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ Bitwarden å®¢æˆ·ç«¯ç™»å½•äº†ã€‚\n\nğŸ“§ é‚®ç®±ï¼š' + email + '\nğŸ”‘ è¯·ç‰¢è®°ä½ çš„ä¸»å¯†ç ï¼ŒæœåŠ¡å™¨ä¸å­˜å‚¨æ˜æ–‡å¯†ç ã€‚', 'success');

            // æ¸…ç©ºè¡¨å•
            registerEmailInput.value = '';
            registerPasswordInput.value = '';
            registerPasswordConfirmInput.value = '';
            registerHintInput.value = '';
        } catch (err) {
            showResult(registerResultEl, 'âŒ ' + String(err), 'error');
        }
    });

    // ä¿®æ”¹ä¸»å¯†ç 

    // ä¿®æ”¹ä¸»å¯†ç 
    submitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultEl);

        try {
            const email = emailInput.value.trim();
            const oldPassword = oldPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const hint = hintInput.value.trim();

            if (!email || !oldPassword || !newPassword) {
                showResult(resultEl, 'âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            if (oldPassword === newPassword) {
                showResult(resultEl, 'âŒ æ–°æ—§ä¸»å¯†ç ä¸èƒ½ç›¸åŒ', 'error');
                return;
            }

            showResult(resultEl, 'â³ æ­£åœ¨è¯»å– KDF å‚æ•°...', 'info');
            const kdfIterations = await prelogin(email);

            showResult(resultEl, 'â³ æ­£åœ¨éªŒè¯æ—§å¯†ç å¹¶ç™»å½•...', 'info');
            const oldMasterKey = await deriveMasterKey(email, oldPassword, kdfIterations);
            const oldMasterPasswordHash = await deriveMasterPasswordHash(oldMasterKey, oldPassword);

            const tokenJson = await login(email, oldMasterPasswordHash);
            const accessToken = tokenJson.access_token;
            const protectedSymmetricKey = tokenJson.Key;

            showResult(resultEl, 'â³ æ­£åœ¨é‡æ–°åŠ å¯†ç”¨æˆ·å¯†é’¥...', 'info');
            const oldStretched = await stretchMasterKey(oldMasterKey);
            const decrypted = await decryptEncString(protectedSymmetricKey, oldStretched.encKey, oldStretched.macKey);
            const symmetricKeyPlain = decrypted.plainBytes;

            const newMasterKey = await deriveMasterKey(email, newPassword, kdfIterations);
            const newMasterPasswordHash = await deriveMasterPasswordHash(newMasterKey, newPassword);
            const newStretched = await stretchMasterKey(newMasterKey);
            const newProtectedSymmetricKey = await encryptEncString(
                symmetricKeyPlain,
                newStretched.encKey,
                newStretched.macKey,
                decrypted.usedPadding
            );

            showResult(resultEl, 'â³ æ­£åœ¨æäº¤ä¿®æ”¹...', 'info');
            const changeResp = await fetch('/api/accounts/password', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    masterPasswordHash: oldMasterPasswordHash,
                    newMasterPasswordHash: newMasterPasswordHash,
                    masterPasswordHint: hint ? hint : null,
                    userSymmetricKey: newProtectedSymmetricKey,
                    kdf: 0,
                    kdfIterations: kdfIterations
                })
            });
            const changeText = await changeResp.text();
            if (!changeResp.ok) {
                showResult(resultEl, `âŒ ä¿®æ”¹å¤±è´¥ HTTP ${changeResp.status}\n${changeText}`, 'error');
                return;
            }

            showResult(resultEl, `âœ… ä¸»å¯†ç ä¿®æ”¹æˆåŠŸï¼\n\nè¯·åœ¨ Bitwarden å®¢æˆ·ç«¯ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ã€‚\n\nğŸ” åŠ å¯†ä¿¡æ¯ï¼šiv=${decrypted.ivLen} ct=${decrypted.ctLen} mac=${decrypted.macLen} padding=${decrypted.usedPadding ? 'pkcs7' : 'none'}`, 'success');

            // æ¸…ç©ºå¯†ç å­—æ®µ
            oldPasswordInput.value = '';
            newPasswordInput.value = '';
        } catch (err) {
            showResult(resultEl, 'âŒ ' + String(err), 'error');
        }
    });

    // ä¿®æ”¹é‚®ç®±
    submitEmailBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultEmailEl);

        try {
            const emailCurrent = emailCurrentInput.value.trim();
            const emailNew = emailNewInput.value.trim();
            const emailNewConfirm = emailNewConfirmInput.value.trim();
            const password = emailPasswordInput.value;

            if (!emailCurrent || !emailNew || !emailNewConfirm || !password) {
                showResult(resultEmailEl, 'âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            if (emailNew.toLowerCase() !== emailNewConfirm.toLowerCase()) {
                showResult(resultEmailEl, 'âŒ ä¸¤æ¬¡è¾“å…¥çš„æ–°é‚®ç®±ä¸ä¸€è‡´', 'error');
                return;
            }
            if (emailCurrent.toLowerCase() === emailNew.toLowerCase()) {
                showResult(resultEmailEl, 'âŒ æ–°æ—§é‚®ç®±ä¸èƒ½ç›¸åŒ', 'error');
                return;
            }

            showResult(resultEmailEl, 'â³ æ­£åœ¨è¯»å– KDF å‚æ•°...', 'info');
            const kdfIterations = await prelogin(emailCurrent);

            showResult(resultEmailEl, 'â³ æ­£åœ¨éªŒè¯èº«ä»½å¹¶ç™»å½•...', 'info');
            const oldMasterKey = await deriveMasterKey(emailCurrent, password, kdfIterations);
            const oldMasterPasswordHash = await deriveMasterPasswordHash(oldMasterKey, password);
            const tokenJson = await login(emailCurrent, oldMasterPasswordHash);
            const accessToken = tokenJson.access_token;
            const protectedSymmetricKey = tokenJson.Key;

            showResult(resultEmailEl, 'â³ æ­£åœ¨é‡æ–°åŠ å¯†ç”¨æˆ·å¯†é’¥...', 'info');
            const oldStretched = await stretchMasterKey(oldMasterKey);
            const decrypted = await decryptEncString(protectedSymmetricKey, oldStretched.encKey, oldStretched.macKey);
            const symmetricKeyPlain = decrypted.plainBytes;

            const newMasterKey = await deriveMasterKey(emailNew, password, kdfIterations);
            const newMasterPasswordHash = await deriveMasterPasswordHash(newMasterKey, password);
            const newStretched = await stretchMasterKey(newMasterKey);
            const newProtectedSymmetricKey = await encryptEncString(
                symmetricKeyPlain,
                newStretched.encKey,
                newStretched.macKey,
                decrypted.usedPadding
            );

            showResult(resultEmailEl, 'â³ æ­£åœ¨æäº¤ä¿®æ”¹...', 'info');
            const changeResp = await fetch('/api/accounts/email', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    masterPasswordHash: oldMasterPasswordHash,
                    newMasterPasswordHash: newMasterPasswordHash,
                    newEmail: emailNew,
                    userSymmetricKey: newProtectedSymmetricKey,
                    kdf: 0,
                    kdfIterations: kdfIterations
                })
            });
            const changeText = await changeResp.text();
            if (!changeResp.ok) {
                showResult(resultEmailEl, `âŒ ä¿®æ”¹å¤±è´¥ HTTP ${changeResp.status}\n${changeText}`, 'error');
                return;
            }

            showResult(resultEmailEl, `âœ… é‚®ç®±ä¿®æ”¹æˆåŠŸï¼\n\nè¯·ä½¿ç”¨æ–°é‚®ç®±é‡æ–°ç™»å½• Bitwarden å®¢æˆ·ç«¯ã€‚\n\nğŸ“§ æ–°é‚®ç®±ï¼š${emailNew}\nğŸ” åŠ å¯†ä¿¡æ¯ï¼šiv=${decrypted.ivLen} ct=${decrypted.ctLen} mac=${decrypted.macLen} padding=${decrypted.usedPadding ? 'pkcs7' : 'none'}`, 'success');

            // æ¸…ç©ºè¡¨å•
            emailCurrentInput.value = '';
            emailNewInput.value = '';
            emailNewConfirmInput.value = '';
            emailPasswordInput.value = '';
        } catch (err) {
            showResult(resultEmailEl, 'âŒ ' + String(err), 'error');
        }
    });


    let totpAccessToken = null;

    // TOTP ç”Ÿæˆå¯†é’¥
    totpRequestBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultTotpEl);
        totpSecretInput.value = '';
        totpOtpauthInput.value = '';
        totpQrImg.removeAttribute('src');
        totpAccessToken = null;

        try {
            const email = totpEmailInput.value.trim();
            const password = totpPasswordInput.value;
            if (!email || !password) {
                showResult(resultTotpEl, 'âŒ è¯·å¡«å†™é‚®ç®±ä¸ä¸»å¯†ç ', 'error');
                return;
            }

            showResult(resultTotpEl, 'â³ æ­£åœ¨è¯»å– KDF å‚æ•°...', 'info');
            const kdfIterations = await prelogin(email);
            const masterKey = await deriveMasterKey(email, password, kdfIterations);
            const masterPasswordHash = await deriveMasterPasswordHash(masterKey, password);

            showResult(resultTotpEl, 'â³ æ­£åœ¨ç™»å½•è·å–æˆæƒ...', 'info');
            const tokenJson = await login(email, masterPasswordHash);
            totpAccessToken = tokenJson.access_token;

            showResult(resultTotpEl, 'â³ æ­£åœ¨ç”Ÿæˆ TOTP å¯†é’¥...', 'info');
            const resp = await fetch('/api/two-factor/authenticator/request', {
                method: 'POST',
                headers: {'Authorization': `Bearer ${totpAccessToken}`}
            });
            const text = await resp.text();
            if (!resp.ok) {
                showResult(resultTotpEl, `âŒ è¯·æ±‚å¤±è´¥ HTTP ${resp.status}\n${text}`, 'error');
                return;
            }
            const data = JSON.parse(text);
            totpSecretInput.value = data.secret || '';
            totpOtpauthInput.value = data.otpauth || '';
            if (data.qrBase64) {
                totpQrImg.setAttribute('src', `data:image/png;base64,${data.qrBase64}`);
            } else {
                totpQrImg.removeAttribute('src');
            }
            showResult(resultTotpEl, 'âœ… å¯†é’¥å·²ç”Ÿæˆï¼\n\nè¯·åœ¨è®¤è¯å™¨ App ä¸­æ·»åŠ åï¼Œè¾“å…¥éªŒè¯ç å¹¶ç‚¹å‡»"å¯ç”¨éªŒè¯"ã€‚', 'success');
        } catch (err) {
            showResult(resultTotpEl, 'âŒ ' + String(err), 'error');
        }
    });

    // TOTP å¯ç”¨
    totpEnableBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultTotpEl);

        try {
            if (!totpAccessToken) {
                showResult(resultTotpEl, 'âŒ è¯·å…ˆç‚¹å‡»"ç”Ÿæˆå¯†é’¥"æŒ‰é’®', 'error');
                return;
            }
            const code = totpCodeInput.value.trim();
            if (!code) {
                showResult(resultTotpEl, 'âŒ è¯·è¾“å…¥ 6 ä½éªŒè¯ç ', 'error');
                return;
            }

            showResult(resultTotpEl, 'â³ æ­£åœ¨å¯ç”¨äºŒæ¬¡éªŒè¯...', 'info');
            const resp = await fetch('/api/two-factor/authenticator/enable', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${totpAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({code})
            });
            const text = await resp.text();
            if (!resp.ok) {
                showResult(resultTotpEl, `âŒ å¯ç”¨å¤±è´¥ HTTP ${resp.status}\n${text}`, 'error');
                return;
            }
            showResult(resultTotpEl, 'âœ… äºŒæ¬¡éªŒè¯å·²å¯ç”¨ï¼\n\nä¹‹åç™»å½• Bitwarden å®¢æˆ·ç«¯æ—¶éœ€è¦è¾“å…¥åŠ¨æ€éªŒè¯ç ã€‚', 'success');
            totpCodeInput.value = '';
        } catch (err) {
            showResult(resultTotpEl, 'âŒ ' + String(err), 'error');
        }
    });

    // TOTP ç¦ç”¨
    totpDisableBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultTotpEl);

        try {
            if (!totpAccessToken) {
                showResult(resultTotpEl, 'âŒ è¯·å…ˆå¡«å†™é‚®ç®±ä¸ä¸»å¯†ç å¹¶ç‚¹å‡»"ç”Ÿæˆå¯†é’¥"è·å–æˆæƒ', 'error');
                return;
            }
            const code = totpCodeInput.value.trim();
            if (!code) {
                showResult(resultTotpEl, 'âŒ è¯·è¾“å…¥ 6 ä½éªŒè¯ç ', 'error');
                return;
            }

            showResult(resultTotpEl, 'â³ æ­£åœ¨ç¦ç”¨äºŒæ¬¡éªŒè¯...', 'info');
            const resp = await fetch('/api/two-factor/authenticator/disable', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${totpAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({code})
            });
            const text = await resp.text();
            if (!resp.ok) {
                showResult(resultTotpEl, `âŒ ç¦ç”¨å¤±è´¥ HTTP ${resp.status}\n${text}`, 'error');
                return;
            }
            showResult(resultTotpEl, 'âœ… äºŒæ¬¡éªŒè¯å·²ç¦ç”¨ï¼', 'success');
            totpCodeInput.value = '';
        } catch (err) {
            showResult(resultTotpEl, 'âŒ ' + String(err), 'error');
        }
    });

    // å¤‡ä»½å¯¼å‡º
    exportBackupBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultBackupEl);

        try {
            const email = backupEmailInput.value.trim();
            const password = backupPasswordInput.value;

            if (!email || !password) {
                showResult(resultBackupEl, 'âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            showResult(resultBackupEl, 'â³ æ­£åœ¨éªŒè¯èº«ä»½...', 'info');

            // è·å– KDF å‚æ•°
            const preloginResp = await fetch('/api/accounts/prelogin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email})
            });
            if (!preloginResp.ok) {
                showResult(resultBackupEl, 'âŒ è·å– KDF å‚æ•°å¤±è´¥', 'error');
                return;
            }
            const {kdfIterations} = await preloginResp.json();

            // ç”Ÿæˆä¸»å¯†é’¥å’Œå¯†ç å“ˆå¸Œ
            const masterKey = await deriveMasterKey(email, password, kdfIterations);
const masterPasswordHash = await deriveMasterPasswordHash(masterKey, password);

            // ç™»å½•è·å– token
            const tokenResp = await fetch('/identity/connect/token', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    grant_type: 'password',
                    username: email,
                    password: masterPasswordHash,
                    scope: 'api offline_access',
                    client_id: 'web',
                    deviceType: 3,
                    deviceName: 'Chrome',
                    deviceIdentifier: crypto.randomUUID()
                })
            });

            if (!tokenResp.ok) {
                showResult(resultBackupEl, 'âŒ ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            const {access_token} = await tokenResp.json();

            showResult(resultBackupEl, 'â³ æ­£åœ¨å¯¼å‡ºå¤‡ä»½...', 'info');

            // è°ƒç”¨å¯¼å‡ºæ¥å£
            const exportResp = await fetch('/api/accounts/export', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${access_token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({masterPasswordHash: masterPasswordHash})
            });

            if (!exportResp.ok) {
                const text = await exportResp.text();
                showResult(resultBackupEl, `âŒ å¯¼å‡ºå¤±è´¥ HTTP ${exportResp.status}\n${text}`, 'error');
                return;
            }

            const backupData = await exportResp.json();

            // ä¸‹è½½å¤‡ä»½æ–‡ä»¶
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `warden-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showResult(resultBackupEl, 'âœ… å¤‡ä»½å¯¼å‡ºæˆåŠŸï¼', 'success');
            backupPasswordInput.value = '';
        } catch (err) {
            showResult(resultBackupEl, 'âŒ ' + String(err), 'error');
        }
    });

    // å¯¼å…¥è¿˜åŸ
    importBackupBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultBackupEl);

        try {
            const email = importEmailInput.value.trim();
            const password = importPasswordInput.value;
            const file = importFileInput.files[0];

            if (!email || !password) {
                showResult(resultBackupEl, 'âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            if (!file) {
                showResult(resultBackupEl, 'âŒ è¯·é€‰æ‹©å¤‡ä»½æ–‡ä»¶', 'error');
                return;
            }

            showResult(resultBackupEl, 'â³ æ­£åœ¨éªŒè¯èº«ä»½...', 'info');

            // è·å– KDF å‚æ•°
            const preloginResp = await fetch('/api/accounts/prelogin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email})
            });
            if (!preloginResp.ok) {
                showResult(resultBackupEl, 'âŒ è·å– KDF å‚æ•°å¤±è´¥', 'error');
                return;
            }
            const {kdfIterations} = await preloginResp.json();

            // ç”Ÿæˆä¸»å¯†é’¥å’Œå¯†ç å“ˆå¸Œ
            const masterKey = await deriveMasterKey(email, password, kdfIterations);
const masterPasswordHash = await deriveMasterPasswordHash(masterKey, password);

            // ç™»å½•è·å– token
            const tokenResp = await fetch('/identity/connect/token', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: new URLSearchParams({
                    grant_type: 'password',
                    username: email,
                    password: masterPasswordHash,
                    scope: 'api offline_access',
                    client_id: 'web',
                    deviceType: 3,
                    deviceName: 'Chrome',
                    deviceIdentifier: crypto.randomUUID()
                })
            });

            if (!tokenResp.ok) {
                showResult(resultBackupEl, 'âŒ ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            const {access_token} = await tokenResp.json();

            showResult(resultBackupEl, 'â³ æ­£åœ¨è¯»å–å¤‡ä»½æ–‡ä»¶...', 'info');

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const backupData = JSON.parse(event.target.result);
                    
                    // éªŒè¯å¤‡ä»½æ–‡ä»¶æ ¼å¼
                    if (!backupData.folders || !backupData.items) {
                        showResult(resultBackupEl, 'âŒ å¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘å¿…è¦å­—æ®µ', 'error');
                        return;
                    }

                    showResult(resultBackupEl, 'â³ æ­£åœ¨å¯¼å…¥æ•°æ®...', 'info');

                    // è½¬æ¢ä¸ºåç«¯æœŸæœ›çš„æ ¼å¼
                    const importData = {
                        folders: backupData.folders.map(f => ({
                            id: f.id,
                            name: f.name
                        })),
                        ciphers: backupData.items.map(item => ({
                            type: item.type || 1,
                            folderId: item.folderId || null,
                            organizationId: item.organizationId || null,
                            name: item.name || '',
                            notes: item.notes || null,
                            favorite: item.favorite || false,
                            login: item.login || null,
                            card: item.card || null,
                            identity: item.identity || null,
                            secureNote: item.secureNote || null,
                            fields: item.fields || null,
                            passwordHistory: item.passwordHistory || null,
                            reprompt: item.reprompt || 0,
                            encryptedFor: email  // æ ‡è®°ä¸ºå½“å‰ç”¨æˆ·åŠ å¯†
                        })),
                        folderRelationships: []
                    };

                    // è°ƒç”¨å¯¼å…¥æ¥å£
                    const importResp = await fetch('/api/ciphers/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${access_token}`
                        },
                        body: JSON.stringify(importData)
                    });

                    if (!importResp.ok) {
                        const errorText = await importResp.text();
                        showResult(resultBackupEl, `âŒ å¯¼å…¥å¤±è´¥ï¼š${errorText}`, 'error');
                        return;
                    }

                    showResult(resultBackupEl, `âœ… å¯¼å…¥æˆåŠŸï¼å·²å¯¼å…¥ ${importData.folders.length} ä¸ªæ–‡ä»¶å¤¹å’Œ ${importData.ciphers.length} ä¸ªå¯†ç é¡¹`, 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    importEmailInput.value = '';
                    importPasswordInput.value = '';
                    importFileInput.value = '';
                } catch (err) {
                    showResult(resultBackupEl, 'âŒ å¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + String(err), 'error');
                }
            };
            reader.readAsText(file);
        } catch (err) {
            showResult(resultBackupEl, 'âŒ ' + String(err), 'error');
        }
    });

    // åˆ é™¤è´¦å·
    deleteAccountBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultDeleteEl);

        try {
            const email = deleteEmailInput.value.trim();
            const password = deletePasswordInput.value;

            if (!email || !password) {
                showResult(resultDeleteEl, 'âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            // ä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†ç¡®è®¤
            const confirmDialog = document.createElement('div');
            confirmDialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease;
            `;
            
            const dialogBox = document.createElement('div');
            dialogBox.style.cssText = `
                background: var(--bg-card);
                border: 2px solid var(--danger-color);
                border-radius: 16px;
                padding: 2rem;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
                animation: slideIn 0.3s ease;
            `;
            
            dialogBox.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
                    <h3 style="color: var(--danger-color); margin-bottom: 1rem;">ç¡®è®¤åˆ é™¤è´¦å·</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                        æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨çš„è´¦å·å’Œæ‰€æœ‰æ•°æ®ï¼Œæ— æ³•æ¢å¤ï¼<br/>
                        è¯·è¾“å…¥ <strong style="color: var(--danger-color);">DELETE</strong> ç¡®è®¤åˆ é™¤
                    </p>
                    <input type="text" id="deleteConfirmInput" placeholder="è¾“å…¥ DELETE" 
                        style="width: 100%; padding: 0.75rem; margin-bottom: 1.5rem; 
                        background: var(--bg-section); border: 1px solid var(--border-color); 
                        border-radius: 12px; color: var(--text-primary); font-size: 1rem;">
                    <div style="display: flex; gap: 1rem;">
                        <button id="cancelDelete" style="flex: 1; padding: 0.75rem; 
                            background: var(--bg-section); border: 1px solid var(--border-color); 
                            border-radius: 12px; color: var(--text-primary); cursor: pointer; 
                            font-size: 1rem; transition: all 0.3s;">
                            å–æ¶ˆ
                        </button>
                        <button id="confirmDelete" style="flex: 1; padding: 0.75rem; 
                            background: var(--danger-color); border: none; 
                            border-radius: 12px; color: white; cursor: pointer; 
                            font-size: 1rem; font-weight: 600; transition: all 0.3s;">
                            ç¡®è®¤åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
            
            confirmDialog.appendChild(dialogBox);
            document.body.appendChild(confirmDialog);
            
            const deleteConfirmInput = document.getElementById('deleteConfirmInput');
            const cancelBtn = document.getElementById('cancelDelete');
            const confirmBtn = document.getElementById('confirmDelete');
            
            // å–æ¶ˆæŒ‰é’®
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(confirmDialog);
            });
            
            // ç¡®è®¤æŒ‰é’®
            confirmBtn.addEventListener('click', async () => {
                const confirmText = deleteConfirmInput.value.trim();
                
                if (confirmText !== 'DELETE') {
                    deleteConfirmInput.style.borderColor = 'var(--danger-color)';
                    deleteConfirmInput.focus();
                    return;
                }
                
                document.body.removeChild(confirmDialog);
                
                showResult(resultDeleteEl, 'â³ æ­£åœ¨éªŒè¯èº«ä»½...', 'info');

                // è·å– KDF å‚æ•°
                const preloginResp = await fetch('/api/accounts/prelogin', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });
                if (!preloginResp.ok) {
                    showResult(resultDeleteEl, 'âŒ è·å– KDF å‚æ•°å¤±è´¥', 'error');
                    return;
                }
                const {kdfIterations} = await preloginResp.json();

                // ç”Ÿæˆä¸»å¯†é’¥å’Œå¯†ç å“ˆå¸Œ
                const masterKey = await deriveMasterKey(email, password, kdfIterations);
const masterPasswordHash = await deriveMasterPasswordHash(masterKey, password);

                // ç™»å½•è·å– token
                const tokenResp = await fetch('/identity/connect/token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: new URLSearchParams({
                        grant_type: 'password',
                        username: email,
                        password: masterPasswordHash,
                        scope: 'api offline_access',
                        client_id: 'web',
                        deviceType: 3,
                        deviceName: 'Chrome',
                        deviceIdentifier: crypto.randomUUID()
                    })
                });

                if (!tokenResp.ok) {
                    showResult(resultDeleteEl, 'âŒ ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ', 'error');
                    return;
                }

                const {access_token} = await tokenResp.json();

                showResult(resultDeleteEl, 'â³ æ­£åœ¨åˆ é™¤è´¦å·...', 'info');

                // è°ƒç”¨åˆ é™¤æ¥å£
                const deleteResp = await fetch('/api/accounts', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${access_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({masterPasswordHash: masterPasswordHash})
                });

                if (!deleteResp.ok) {
                    const text = await deleteResp.text();
                    showResult(resultDeleteEl, `âŒ åˆ é™¤å¤±è´¥ HTTP ${deleteResp.status}\n${text}`, 'error');
                    return;
                }

                showResult(resultDeleteEl, 'âœ… è´¦å·å·²æˆåŠŸåˆ é™¤ï¼', 'success');
                deleteEmailInput.value = '';
                deletePasswordInput.value = '';
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            confirmDialog.addEventListener('click', (e) => {
                if (e.target === confirmDialog) {
                    document.body.removeChild(confirmDialog);
                }
            });
            
        } catch (err) {
            showResult(resultDeleteEl, 'âŒ ' + String(err), 'error');
        }
    });
</script>
</body>
</html>
