name: Build

on:
    push:
        branches: [main, uat, release*]
    pull_request_target:
        branches: [main, uat, release*]
    workflow_dispatch:

jobs:
    build:
        name: Run production build
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Setup Rust
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: wasm32-unknown-unknown
                  components: rust-src, llvm-tools-preview

            - name: Install lld and clang
              run: sudo apt install -y lld clang

            - name: Clean up potential conflicts
              run: |
                  # 清理可能存在的旧版本
                  cargo clean || true
                  rm -rf ~/.cargo/registry/index/* || true
                  rm -rf ~/.cargo/registry/cache/* || true

            - name: Cache Cargo dependencies
              uses: actions/cache@v3
              with:
                  path: |
                      ~/.cargo/registry
                      ~/.cargo/git
                      target
                  key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-cargo-

            - name: Update Cargo dependencies
              run: |
                  cargo update
                  # 确保 wasm-bindgen-cli 版本正确
                  cargo install wasm-bindgen-cli --version 0.2.106 --locked

            - name: Install wrangler v4
              run: |
                  # 安装最新版 wrangler
                  npm install -g wrangler@4
                  npx wrangler --version

            - name: Install worker-build with correct version
              run: |
                  # 清理可能存在的旧版本
                  cargo uninstall worker-build 2>/dev/null || true
                  # 安装最新版 worker-build
                  cargo install worker-build --locked

            - name: Replace D1_DATABASE_ID in wrangler.toml
              run: |
                  if [ -n "${{ secrets.D1_DATABASE_ID }}" ]; then
                      sed -i "s/\${D1_DATABASE_ID}/${{ secrets.D1_DATABASE_ID }}/g" wrangler.toml
                  fi

            - name: Build the project
              env:
                  D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
              run: |
                  # 验证依赖版本
                  cargo tree | grep wasm-bindgen || echo "Checking wasm-bindgen version"
                  
                  # 构建项目
                  cargo build --release --target wasm32-unknown-unknown
                  
                  # 生成 worker.js
                  worker-build --release

            - name: Deploy to Cloudflare
              uses: cloudflare/wrangler-action@v3
              env:
                  D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  # 指定使用 wrangler v4
                  wranglerVersion: '4'
                  command: deploy
